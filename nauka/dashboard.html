<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Panel</title>
<style>
:root {
  --bg1:#8f94fb;
  --bg2:#4e54c8;
  --card-bg:#f0f3ff;
  --font-size:16px;
  --font-weight:600;
  --text-color:#333;
  --wrapper-bg:rgba(255,255,255,0.95);
  --shadow-color:rgba(0,0,0,0.3);
}
body {
  margin:0;
  font-family:"Segoe UI",sans-serif;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  min-height:100vh;
  padding:40px;
  font-size:var(--font-size);
  font-weight:var(--font-weight);
  overflow-x:hidden;
  background-size:400% 400%;
  animation:gradientBG 15s ease infinite;
  color:var(--text-color);
  transition:background 0.5s, color 0.5s;
}
body.night-mode {
  --bg1:#121212;
  --bg2:#000000;
  --card-bg:#1e1e1e;
  --text-color:#e0e0e0;
  --wrapper-bg:rgba(30,30,30,0.95);
  --shadow-color:rgba(0,0,0,0.6);
}
.wrapper {
  max-width:1000px;
  margin:0 auto;
  background:var(--wrapper-bg);
  color:var(--text-color);
  padding:30px;
  border-radius:20px;
  box-shadow:0 10px 30px var(--shadow-color);
  transition:background 0.5s, color 0.5s, box-shadow 0.5s;
}
h2 {margin-top:0;text-align:center;color:var(--bg2)}
.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:20px;
  margin-top:25px;
}
.card {
  background:var(--card-bg);
  padding:20px;
  border-radius:12px;
  text-align:center;
  cursor:pointer;
  transform:rotateY(90deg) scale(0.7);
  opacity:0;
  animation:cardIn 0.8s forwards;
  box-shadow:0 6px 12px var(--shadow-color);
  transition:0.3s transform,0.3s box-shadow, 0.3s background;
  position:relative;
  overflow:hidden;
}
.card:hover {
  transform:rotateY(0deg) scale(1.05) translateY(-10px);
  box-shadow:0 15px 25px var(--shadow-color);
  background:#d9e0ff;
}
body.night-mode .card:hover {
  background:#2a2a2a;
}
.card .emoji {
  font-size:30px;
  display:block;
  transition:transform 0.6s ease;
}
.card:hover .emoji {
  transform:translateY(-10px) rotate(-15deg);
}
.card:nth-child(odd){animation-delay:0.2s}
.card:nth-child(even){animation-delay:0.4s}

.logout {
  margin-top:30px;
  display:block;
  padding:10px 16px;
  border:0;
  border-radius:8px;
  background:#ff4d4d;
  color:#fff;
  cursor:pointer;
  transition:0.2s;
}
.logout:hover {background:#cc0000}

/* zƒôbatka */
.settings-toggle {
  position:fixed;
  top:20px;
  right:20px;
  background:#fff;
  border-radius:50%;
  width:50px;
  height:50px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
  z-index:1000;
  transition:transform 0.3s;
}
body.night-mode .settings-toggle {
  background:#333;
  color:#fff;
}
.settings-toggle:hover {transform:rotate(180deg);}

.settings-panel {
  position:fixed;
  top:0;
  right:-320px;
  width:300px;
  height:100%;
  background:#f7f7f7;
  box-shadow:-4px 0 12px rgba(0,0,0,0.3);
  padding:20px;
  transition:right 0.4s ease;
  z-index:999;
  overflow-y:auto;
}
body.night-mode .settings-panel {
  background:#2a2a2a;
  color:#e0e0e0;
}
.settings-panel.open {right:0;}
.settings-panel h3 {margin-top:0;}
label {display:block;margin:12px 0;font-size:14px}
body.night-mode label {color:#e0e0e0;}

/* Mini-player */
.mini-player {
  position:fixed;
  bottom:20px;
  left:20px;
  width:300px;
  background:var(--wrapper-bg);
  border-radius:12px;
  box-shadow:0 4px 20px var(--shadow-color);
  padding:15px;
  z-index:1000;
  transition:all 0.3s;
}
.mini-player.hidden {
  transform:translateY(150%);
  opacity:0;
}
.mini-player-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.mini-player-title {
  font-weight:bold;
  font-size:14px;
}
.mini-player-controls {
  display:flex;
  align-items:center;
  gap:10px;
}
.mini-player-btn {
  background:none;
  border:none;
  cursor:pointer;
  font-size:16px;
  color:var(--text-color);
}
.mini-player-visualization {
  width:100%;
  height:60px;
  background:#000;
  border-radius:6px;
  margin-top:10px;
  overflow:hidden;
}

/* Playlista */
.playlist-panel {
  position:fixed;
  bottom:20px;
  right:20px;
  width:300px;
  max-height:400px;
  background:var(--wrapper-bg);
  border-radius:12px;
  box-shadow:0 4px 20px var(--shadow-color);
  padding:15px;
  z-index:1000;
  overflow-y:auto;
  transition:all 0.3s;
}
.playlist-panel.hidden {
  transform:translateY(150%);
  opacity:0;
}
.playlist-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.playlist-title {
  font-weight:bold;
}
.playlist-list {
  list-style:none;
  padding:0;
  margin:0;
}
.playlist-item {
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
  margin-bottom:5px;
  transition:background 0.2s;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.playlist-item:hover {
  background:rgba(0,0,0,0.1);
}
body.night-mode .playlist-item:hover {
  background:rgba(255,255,255,0.1);
}
.playlist-item.active {
  background:var(--bg1);
  color:white;
}
.playlist-item-remove {
  background:none;
  border:none;
  color:inherit;
  cursor:pointer;
  font-size:12px;
  opacity:0.7;
}
.playlist-item-remove:hover {
  opacity:1;
}

/* Przyciski przywracania paneli */
.restore-panels {
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:10px;
  z-index:900;
}
.restore-btn {
  background:var(--wrapper-bg);
  border:none;
  border-radius:20px;
  padding:8px 16px;
  font-size:12px;
  cursor:pointer;
  box-shadow:0 2px 8px var(--shadow-color);
  color:var(--text-color);
  display:flex;
  align-items:center;
  gap:5px;
  transition:all 0.3s;
}
.restore-btn:hover {
  transform:translateY(-2px);
  box-shadow:0 4px 12px var(--shadow-color);
}

/* Equalizer controls */
.equalizer-controls {
  background:var(--card-bg);
  padding:15px;
  border-radius:10px;
  margin-top:15px;
}
.equalizer-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.equalizer-title {
  font-weight:bold;
  font-size:14px;
}
.equalizer-presets {
  display:flex;
  gap:5px;
  margin-bottom:10px;
  flex-wrap:wrap;
}
.equalizer-preset {
  background:var(--bg1);
  border:none;
  border-radius:12px;
  padding:4px 8px;
  font-size:10px;
  color:white;
  cursor:pointer;
  transition:all 0.2s;
}
.equalizer-preset:hover {
  opacity:0.8;
  transform:scale(1.05);
}
.equalizer-bands {
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  height:120px;
  margin-bottom:10px;
  padding:10px;
  background:rgba(0,0,0,0.1);
  border-radius:8px;
}
.equalizer-band {
  display:flex;
  flex-direction:column;
  align-items:center;
  flex:1;
}
.equalizer-band-label {
  font-size:10px;
  margin-bottom:5px;
  color:var(--text-color);
}
.equalizer-band-slider {
  writing-mode:bt-lr;
  -webkit-appearance:slider-vertical;
  width:20px;
  height:80px;
}
.equalizer-band-value {
  font-size:10px;
  margin-top:5px;
  color:var(--text-color);
}

/* animacje */
@keyframes cardIn {
  0% {opacity:0;transform:rotateY(90deg) scale(0.7);}
  50% {opacity:1;transform:rotateY(-10deg) scale(1.05);}
  100% {opacity:1;transform:rotateY(0deg) scale(1);}
}
@keyframes gradientBG {
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
</style>
</head>
<body>
<div class="settings-toggle" onclick="toggleSettings()">‚öôÔ∏è</div>
<div class="settings-panel" id="settings">
  <h3>‚öôÔ∏è Ustawienia</h3>
  <label>Kolor t≈Ça 1: <input type="color" id="bg1" value="#8f94fb"></label>
  <label>Kolor t≈Ça 2: <input type="color" id="bg2" value="#4e54c8"></label>
  <label>Kolor kart: <input type="color" id="cardBg" value="#f0f3ff"></label>
  <label>Rozmiar czcionki: 
    <input type="range" id="fontSize" min="12" max="24" value="16">
    <span id="fontSizeVal">16</span>px
  </label>
  <label>Grubo≈õƒá liter: 
    <select id="fontWeight">
      <option value="400">Normalne</option>
      <option value="600" selected>P√≥≈Çgrube</option>
      <option value="700">Grube</option>
    </select>
  </label>
  <label>
    <input type="checkbox" id="nightMode"> Tryb nocny
  </label>
  <label>Otwieraj linki w nowej karcie: 
    <input type="checkbox" id="openNewTab" checked>
  </label>
  <label>Dodaj muzykƒô: <input type="file" id="music" accept="audio/*" multiple></label>
  
  <div class="equalizer-controls">
    <div class="equalizer-header">
      <div class="equalizer-title">üéõÔ∏è Equalizer</div>
      <button class="mini-player-btn" onclick="resetEqualizer()">üîÑ</button>
    </div>
    
    <div class="equalizer-presets">
      <button class="equalizer-preset" onclick="loadPreset('flat')">P≈Çaski</button>
      <button class="equalizer-preset" onclick="loadPreset('bass')">Basy</button>
      <button class="equalizer-preset" onclick="loadPreset('treble')">Wysokie</button>
      <button class="equalizer-preset" onclick="loadPreset('rock')">Rock</button>
      <button class="equalizer-preset" onclick="loadPreset('jazz')">Jazz</button>
      <button class="equalizer-preset" onclick="loadPreset('classical')">Klasyka</button>
    </div>
    
    <div class="equalizer-bands" id="equalizerBands">
      <!-- Bƒôdzie generowane dynamicznie -->
    </div>
    
    <label>G≈Ço≈õno≈õƒá: 
      <input type="range" id="volume" min="0" max="100" value="50">
      <span id="volumeVal">50</span>%
    </label>
  </div>
  
  <audio id="player" style="display:none;"></audio>
</div>

<div class="mini-player" id="miniPlayer">
  <div class="mini-player-header">
    <div class="mini-player-title" id="miniPlayerTitle">Odtwarzacz audio</div>
    <div class="mini-player-controls">
      <button class="mini-player-btn" onclick="previousTrack()">‚èÆÔ∏è</button>
      <button class="mini-player-btn" onclick="togglePlayPause()" id="playPauseBtn">‚è∏Ô∏è</button>
      <button class="mini-player-btn" onclick="nextTrack()">‚è≠Ô∏è</button>
      <button class="mini-player-btn" onclick="toggleMiniPlayer()">‚àí</button>
    </div>
  </div>
  <canvas class="mini-player-visualization" id="visualization"></canvas>
</div>

<div class="playlist-panel" id="playlistPanel">
  <div class="playlist-header">
    <div class="playlist-title">üéµ Playlista (<span id="playlistCount">0</span>)</div>
    <div class="mini-player-controls">
      <button class="mini-player-btn" onclick="shufflePlaylist()">üîÄ</button>
      <button class="mini-player-btn" onclick="clearPlaylist()">üóëÔ∏è</button>
      <button class="mini-player-btn" onclick="togglePlaylist()">‚àí</button>
    </div>
  </div>
  <ul class="playlist-list" id="playlist"></ul>
</div>

<div class="restore-panels" id="restorePanels">
  <button class="restore-btn" onclick="restoreMiniPlayer()">
    <span>üéµ</span> Odtwarzacz
  </button>
  <button class="restore-btn" onclick="restorePlaylist()">
    <span>üìã</span> Playlista
  </button>
  <button class="restore-btn" onclick="restoreEqualizer()">
    <span>üéõÔ∏è</span> Equalizer
  </button>
</div>

<div class="wrapper">
  <h2>üìö Witaj w panelu</h2>
  <div class="grid" id="links"></div>
  <button class="logout" onclick="logout()">Wyloguj</button>
</div>

<script>
if(localStorage.getItem("hasAccess")!=="true"){
  window.location="index.html";
}

const subjects=[
  {name:"Informatyka",emoji:"üíª",url:"informatyka.html"},
  {name:"Witryny pracownia",emoji:"üñ•Ô∏è",url:"witryny_pracownia.html"},
  {name:"Witryny wyk≈Çady",emoji:"üìÑ",url:"witryny_wyklady.html"},
  {name:"Bazy danych pracownia",emoji:"üóÑÔ∏è",url:"bazy_danych_pracownia.html"},
  {name:"Bazy danych wyk≈Çady",emoji:"üìö",url:"bazy_danych_wyklady.html"},
  {name:"Geografia",emoji:"üåç",url:"geografia.html"},
  {name:"Podstawy informatyki",emoji:"üß©",url:"podstawy_informatyki.html"},
  {name:"Angielski",emoji:"üá¨üáß",url:"angielski.html"},
  {name:"Chemia",emoji:"‚öóÔ∏è",url:"chemia.html"},
  {name:"WF",emoji:"üèÉ‚Äç‚ôÇÔ∏è",url:"wf.html"},
  {name:"Matematyka",emoji:"‚ûó",url:"matematyka.html"},
  {name:"Programowanie obiektowe pracownia",emoji:"üßë‚Äçüíª",url:"programowanie_obiektowe_pracownia.html"},
  {name:"Programowanie obiektowe wyk≈Çady",emoji:"üìù",url:"programowanie_obiektowe_wyklady.html"},
  {name:"Edukacja obywatelska",emoji:"üèõÔ∏è",url:"edukacja_obywatelska.html"},
  {name:"Biznes i zarzƒÖdzanie",emoji:"üíº",url:"biznes_i_zarzadzanie.html"},
  {name:"Polski",emoji:"üìñ",url:"polski.html"},
  {name:"Historia",emoji:"üè∫",url:"historia.html"},
  {name:"Niemiecki",emoji:"üá©üá™",url:"niemiecki.html"}
];

// Inicjalizacja link√≥w z opcjƒÖ otwierania w nowej karcie
const grid = document.getElementById("links");
const openNewTab = document.getElementById("openNewTab");

function initializeLinks() {
  grid.innerHTML = '';
  subjects.forEach((s, i) => {
    const div = document.createElement("div");
    div.className = "card";
    
    const link = document.createElement("a");
    link.href = s.url;
    link.innerHTML = `<span class="emoji">${s.emoji}</span>${s.name}`;
    link.style.textDecoration = "none";
    link.style.color = "inherit";
    link.style.display = "block";
    
    // Ustawienie atrybutu target w zale≈ºno≈õci od ustawienia
    if (openNewTab.checked) {
      link.target = "_blank";
      link.rel = "noopener noreferrer";
    }
    
    div.appendChild(link);
    div.style.animationDelay = (i * 0.1) + "s";
    grid.appendChild(div);
  });
}

function logout(){
  localStorage.removeItem("hasAccess");
  window.location="index.html";
}

function toggleSettings(){
  document.getElementById("settings").classList.toggle("open");
}

// Elementy DOM
const bg1=document.getElementById("bg1");
const bg2=document.getElementById("bg2");
const cardBg=document.getElementById("cardBg");
const fontSize=document.getElementById("fontSize");
const fontSizeVal=document.getElementById("fontSizeVal");
const fontWeight=document.getElementById("fontWeight");
const nightMode=document.getElementById("nightMode");
const music=document.getElementById("music");
const player=document.getElementById("player");
const volume=document.getElementById("volume");
const volumeVal=document.getElementById("volumeVal");
const miniPlayer=document.getElementById("miniPlayer");
const playlistPanel=document.getElementById("playlistPanel");
const playlist = document.getElementById("playlist");
const playlistCount = document.getElementById("playlistCount");
const visualization = document.getElementById("visualization");
const restorePanels = document.getElementById("restorePanels");
const equalizerBands = document.getElementById("equalizerBands");

// Kontekst audio i equalizer
let audioContext;
let analyser;
let source;
let dataArray;
let bufferLength;
let canvasCtx = visualization.getContext('2d');
visualization.width = visualization.clientWidth;
visualization.height = visualization.clientHeight;

// Equalizer settings
let equalizerNodes = [];
const eqFrequencies = [60, 170, 350, 1000, 3500, 10000]; // 6-pasmowy equalizer
const eqPresets = {
  flat: [0, 0, 0, 0, 0, 0],
  bass: [8, 6, 4, 0, -2, -4],
  treble: [-4, -2, 0, 2, 6, 8],
  rock: [6, 4, 2, 0, 2, 4],
  jazz: [4, 2, 0, -2, 0, 2],
  classical: [0, 0, 0, 2, 4, 6]
};

// Playlista
let currentPlaylist = [];
let currentTrackIndex = 0;

// Inicjalizacja equalizera
function initializeEqualizer() {
  equalizerBands.innerHTML = '';
  eqFrequencies.forEach((freq, index) => {
    const bandDiv = document.createElement('div');
    bandDiv.className = 'equalizer-band';
    
    const label = document.createElement('div');
    label.className = 'equalizer-band-label';
    label.textContent = freq >= 1000 ? (freq/1000).toFixed(1) + 'k' : freq;
    
    const slider = document.createElement('input');
    slider.type = 'range';
    slider.className = 'equalizer-band-slider';
    slider.min = '-12';
    slider.max = '12';
    slider.value = '0';
    slider.dataset.index = index;
    slider.dataset.frequency = freq;
    
    const value = document.createElement('div');
    value.className = 'equalizer-band-value';
    value.textContent = '0dB';
    value.id = `eqValue${index}`;
    
    slider.addEventListener('input', function() {
      updateEqualizer();
      value.textContent = this.value + 'dB';
    });
    
    bandDiv.appendChild(label);
    bandDiv.appendChild(slider);
    bandDiv.appendChild(value);
    equalizerBands.appendChild(bandDiv);
  });
}

// Inicjalizacja kontekstu audio
function initAudioContext() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    source = audioContext.createMediaElementSource(player);
    
    // Tworzenie filtr√≥w equalizera
    equalizerNodes = [];
    let lastNode = source;
    
    eqFrequencies.forEach(freq => {
      const filter = audioContext.createBiquadFilter();
      filter.type = 'peaking';
      filter.frequency.value = freq;
      filter.Q.value = 1;
      filter.gain.value = 0;
      
      lastNode.connect(filter);
      lastNode = filter;
      equalizerNodes.push(filter);
    });
    
    lastNode.connect(analyser);
    analyser.connect(audioContext.destination);
    
    // Konfiguracja analizatora
    analyser.fftSize = 256;
    bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
    
    // Rozpoczƒôcie wizualizacji
    drawVisualization();
  }
}

// Rysowanie wizualizacji
function drawVisualization() {
  if (!analyser) return;
  
  requestAnimationFrame(drawVisualization);
  
  analyser.getByteFrequencyData(dataArray);
  
  canvasCtx.fillStyle = 'rgb(0, 0, 0)';
  canvasCtx.fillRect(0, 0, visualization.width, visualization.height);
  
  const barWidth = (visualization.width / bufferLength) * 2.5;
  let barHeight;
  let x = 0;
  
  for(let i = 0; i < bufferLength; i++) {
    barHeight = dataArray[i] / 2;
    
    // Gradient kolorystyczny w zale≈ºno≈õci od wysoko≈õci
    const r = Math.min(255, barHeight + 100);
    const g = Math.min(255, 50 + barHeight / 2);
    const b = Math.min(255, 150 + barHeight / 3);
    
    canvasCtx.fillStyle = `rgb(${r}, ${g}, ${b})`;
    canvasCtx.fillRect(x, visualization.height - barHeight, barWidth, barHeight);
    
    x += barWidth + 1;
  }
}

// Aktualizacja equalizera
function updateEqualizer() {
  if (!equalizerNodes.length) return;
  
  const sliders = document.querySelectorAll('.equalizer-band-slider');
  sliders.forEach((slider, index) => {
    if (equalizerNodes[index]) {
      equalizerNodes[index].gain.value = parseFloat(slider.value);
    }
  });
  saveSettings();
}

// ≈Åadowanie preset√≥w equalizera
function loadPreset(presetName) {
  if (!eqPresets[presetName]) return;
  
  const sliders = document.querySelectorAll('.equalizer-band-slider');
  const valueDisplays = document.querySelectorAll('[id^="eqValue"]');
  
  eqPresets[presetName].forEach((value, index) => {
    if (sliders[index]) {
      sliders[index].value = value;
      if (valueDisplays[index]) {
        valueDisplays[index].textContent = value + 'dB';
      }
    }
  });
  
  updateEqualizer();
}

// Reset equalizera
function resetEqualizer() {
  loadPreset('flat');
}

// Aktualizacja ustawie≈Ñ
function updateStyles(){
  document.documentElement.style.setProperty("--bg1",bg1.value);
  document.documentElement.style.setProperty("--bg2",bg2.value);
  document.documentElement.style.setProperty("--card-bg",cardBg.value);
  document.documentElement.style.setProperty("--font-size",fontSize.value+"px");
  document.documentElement.style.setProperty("--font-weight",fontWeight.value);
  fontSizeVal.textContent=fontSize.value;
  saveSettings();
}

// Prze≈ÇƒÖczanie trybu nocnego
function toggleNightMode() {
  document.body.classList.toggle('night-mode');
  saveSettings();
}

// Aktualizacja otwierania w nowych kartach
function updateLinkBehavior() {
  initializeLinks();
  saveSettings();
}

// Dodawanie utwor√≥w do playlisty
music.addEventListener("change", e => {
  const files = e.target.files;
  if (files.length > 0) {
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      currentPlaylist.push({
        name: file.name.replace(/\.[^/.]+$/, ""), // Usu≈Ñ rozszerzenie
        url: URL.createObjectURL(file)
      });
    }
    updatePlaylist();
    if (currentPlaylist.length === files.length && !player.src) {
      playTrack(0);
    }
  }
});

// Aktualizacja wy≈õwietlania playlisty
function updatePlaylist() {
  playlist.innerHTML = '';
  currentPlaylist.forEach((track, index) => {
    const li = document.createElement('li');
    li.className = `playlist-item ${index === currentTrackIndex ? 'active' : ''}`;
    li.innerHTML = `
      <span>${track.name}</span>
      <button class="playlist-item-remove" onclick="event.stopPropagation(); removeFromPlaylist(${index})">‚úï</button>
    `;
    li.addEventListener('click', () => playTrack(index));
    playlist.appendChild(li);
  });
  playlistCount.textContent = currentPlaylist.length;
}

// Odtwarzanie konkretnego utworu
function playTrack(index) {
  if (index >= 0 && index < currentPlaylist.length) {
    currentTrackIndex = index;
    player.src = currentPlaylist[index].url;
    player.play().catch(e => console.log("Autoplay blocked:", e));
    document.getElementById('miniPlayerTitle').textContent = currentPlaylist[index].name;
    updatePlaylist();
    showMiniPlayer();
    showPlaylist();
    
    // Inicjalizacja kontekstu audio po pierwszym odtworzeniu
    if (!audioContext) {
      initAudioContext();
    }
  }
}

// Nastƒôpny utw√≥r
function nextTrack() {
  if (currentPlaylist.length > 0) {
    const nextIndex = (currentTrackIndex + 1) % currentPlaylist.length;
    playTrack(nextIndex);
  }
}

// Poprzedni utw√≥r
function previousTrack() {
  if (currentPlaylist.length > 0) {
    const prevIndex = (currentTrackIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
    playTrack(prevIndex);
  }
}

// Tasowanie playlisty
function shufflePlaylist() {
  if (currentPlaylist.length > 1) {
    for (let i = currentPlaylist.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [currentPlaylist[i], currentPlaylist[j]] = [currentPlaylist[j], currentPlaylist[i]];
    }
    // Zachowaj aktualny utw√≥r na pierwszej pozycji
    const currentTrack = currentPlaylist.splice(currentTrackIndex, 1)[0];
    currentPlaylist.unshift(currentTrack);
    currentTrackIndex = 0;
    updatePlaylist();
    saveSettings();
  }
}

// Czyszczenie playlisty
function clearPlaylist() {
  if (confirm('Czy na pewno chcesz wyczy≈õciƒá playlistƒô?')) {
    currentPlaylist = [];
    currentTrackIndex = 0;
    player.pause();
    player.src = '';
    updatePlaylist();
    saveSettings();
  }
}

// Usuwanie z playlisty
function removeFromPlaylist(index) {
  currentPlaylist.splice(index, 1);
  if (currentTrackIndex >= index && currentTrackIndex > 0) {
    currentTrackIndex--;
  }
  if (currentPlaylist.length === 0) {
    player.pause();
    player.src = '';
    miniPlayer.classList.add('hidden');
  } else {
    updatePlaylist();
    if (index === currentTrackIndex) {
      playTrack(currentTrackIndex);
    }
  }
  saveSettings();
}

// Prze≈ÇƒÖczanie odtwarzania/pauzy
function togglePlayPause() {
  if (player.paused) {
    player.play().catch(e => console.log("Play failed:", e));
    document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è';
  } else {
    player.pause();
    document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è';
  }
}

// Pokazywanie/ukrywanie mini-playera
function toggleMiniPlayer() {
  miniPlayer.classList.toggle('hidden');
  updateRestoreButtons();
  saveSettings();
}

// Pokazywanie/ukrywanie playlisty
function togglePlaylist() {
  playlistPanel.classList.toggle('hidden');
  updateRestoreButtons();
  saveSettings();
}

// Automatyczne pokazywanie mini-playera i playlisty
function showMiniPlayer() {
  miniPlayer.classList.remove('hidden');
  updateRestoreButtons();
}

function showPlaylist() {
  playlistPanel.classList.remove('hidden');
  updateRestoreButtons();
}

// Przywracanie paneli
function restoreMiniPlayer() {
  miniPlayer.classList.remove('hidden');
  updateRestoreButtons();
  saveSettings();
}

function restorePlaylist() {
  playlistPanel.classList.remove('hidden');
  updateRestoreButtons();
  saveSettings();
}

function restoreEqualizer() {
  document.getElementById('settings').classList.add('open');
}

// Aktualizacja przycisk√≥w przywracania
function updateRestoreButtons() {
  const miniHidden = miniPlayer.classList.contains('hidden');
  const playlistHidden = playlistPanel.classList.contains('hidden');
  
  // Pokazuj przyciski tylko je≈õli jakie≈õ panele sƒÖ ukryte
  restorePanels.style.display = (miniHidden || playlistHidden) ? 'flex' : 'none';
}

// Obs≈Çuga zdarze≈Ñ odtwarzacza
player.addEventListener('play', () => {
  document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è';
  if (!audioContext) {
    initAudioContext();
  }
});

player.addEventListener('pause', () => {
  document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è';
});

player.addEventListener('ended', () => {
  // Automatyczne przej≈õcie do nastƒôpnego utworu
  if (currentTrackIndex < currentPlaylist.length - 1) {
    playTrack(currentTrackIndex + 1);
  } else {
    document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è';
  }
});

player.addEventListener('volumechange', () => {
  volume.value = player.volume * 100;
  volumeVal.textContent = volume.value;
});

// Obs≈Çuga zmiany g≈Ço≈õno≈õci
volume.addEventListener('input', () => {
  player.volume = volume.value / 100;
  volumeVal.textContent = volume.value;
  saveSettings();
});

// Zapisywanie ustawie≈Ñ
function saveSettings(){
  const eqValues = Array.from(document.querySelectorAll('.equalizer-band-slider')).map(s => s.value);
  
  const settings={
    bg1:bg1.value,
    bg2:bg2.value,
    cardBg:cardBg.value,
    fontSize:fontSize.value,
    fontWeight:fontWeight.value,
    nightMode:nightMode.checked,
    openNewTab:openNewTab.checked,
    volume:volume.value,
    eqValues:eqValues,
    miniPlayerHidden:miniPlayer.classList.contains('hidden'),
    playlistHidden:playlistPanel.classList.contains('hidden'),
    playlist:currentPlaylist.map(track => ({name: track.name, url: track.url})),
    currentTrackIndex:currentTrackIndex
  };
  localStorage.setItem("panel-settings",JSON.stringify(settings));
}

// ≈Åadowanie ustawie≈Ñ
function loadSettings(){
  const s=JSON.parse(localStorage.getItem("panel-settings")||"{}");
  if(s.bg1){bg1.value=s.bg1;document.documentElement.style.setProperty("--bg1",s.bg1);}
  if(s.bg2){bg2.value=s.bg2;document.documentElement.style.setProperty("--bg2",s.bg2);}
  if(s.cardBg){cardBg.value=s.cardBg;document.documentElement.style.setProperty("--card-bg",s.cardBg);}
  if(s.fontSize){fontSize.value=s.fontSize;document.documentElement.style.setProperty("--font-size",s.fontSize+"px");fontSizeVal.textContent=s.fontSize;}
  if(s.fontWeight){fontWeight.value=s.fontWeight;document.documentElement.style.setProperty("--font-weight",s.fontWeight);}
  if(s.nightMode){nightMode.checked=s.nightMode;if(s.nightMode) document.body.classList.add('night-mode');}
  if(s.openNewTab !== undefined){openNewTab.checked=s.openNewTab;}
  if(s.volume){volume.value=s.volume;player.volume=s.volume/100;volumeVal.textContent=s.volume;}
  if(s.eqValues){
    const sliders = document.querySelectorAll('.equalizer-band-slider');
    const valueDisplays = document.querySelectorAll('[id^="eqValue"]');
    s.eqValues.forEach((value, index) => {
      if(sliders[index]) {
        sliders[index].value = value;
        if(valueDisplays[index]) {
          valueDisplays[index].textContent = value + 'dB';
        }
      }
    });
  }
  if(s.miniPlayerHidden && s.miniPlayerHidden === true){miniPlayer.classList.add('hidden');}
  if(s.playlistHidden && s.playlistHidden === true){playlistPanel.classList.add('hidden');}
  if(s.playlist){currentPlaylist=s.playlist;}
  if(s.currentTrackIndex !== undefined){currentTrackIndex=s.currentTrackIndex;}
  
  updateEqualizer();
  updatePlaylist();
  updateRestoreButtons();
  initializeLinks();
}

// Inicjalizacja
initializeEqualizer();
initializeLinks();

[bg1,bg2,cardBg,fontSize,fontWeight].forEach(el=>el.addEventListener("input",updateStyles));
nightMode.addEventListener("change", toggleNightMode);
openNewTab.addEventListener("change", updateLinkBehavior);
loadSettings();

// Obs≈Çuga zmiany rozmiaru okna
window.addEventListener('resize', () => {
  visualization.width = visualization.clientWidth;
  visualization.height = visualization.clientHeight;
});

// Automatyczne zapisywanie co 10 sekund
setInterval(saveSettings, 10000);
</script>
</body>
</html>
